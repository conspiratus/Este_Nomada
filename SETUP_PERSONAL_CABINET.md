# Настройка Личного Кабинета и Корзины

## Шаги для запуска

### 1. Установка зависимостей

```bash
cd backend
pip install -r requirements.txt
```

Новые зависимости:
- `geopy==2.4.1` - для расчета расстояния доставки
- `cryptography==42.0.2` - для шифрования персональных данных (уже была)

### 2. Генерация ключа шифрования

Сгенерируйте ключ шифрования для персональных данных:

```python
from cryptography.fernet import Fernet
print(Fernet.generate_key().decode())
```

Добавьте полученный ключ в `.env` файл:

```env
ENCRYPTION_KEY=ваш_ключ_шифрования
```

### 3. Создание и применение миграций

```bash
cd backend
python manage.py makemigrations
python manage.py migrate
```

### 4. Настройка email для подтверждения регистрации

Добавьте в `.env` файл настройки email (опционально, если хотите отправлять подтверждения):

```env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
```

### 5. Настройка доставки в админке

1. Войдите в админку Django
2. Перейдите в раздел "Настройки доставки и ЛК"
3. Укажите:
   - Координаты точки доставки (широта, долгота)
   - Базовую стоимость доставки
   - Стоимость за километр
   - Порог бесплатной доставки (опционально)
   - Максимальное расстояние доставки (опционально)

### 6. Настройка JWT (если еще не настроено)

JWT уже настроен в `settings.py`. Для работы с авторизацией используйте:

```python
from rest_framework_simplejwt.tokens import RefreshToken

# Создание токена для пользователя
refresh = RefreshToken.for_user(user)
access_token = refresh.access_token
```

## API Endpoints

### Клиенты
- `POST /api/customers/register/` - Регистрация нового клиента
- `GET /api/customers/verify-email/?token=...` - Подтверждение email
- `GET /api/customers/profile/` - Профиль текущего пользователя (требует авторизации)

### Корзина
- `GET /api/cart/` - Получить корзину
- `POST /api/cart/{id}/add_item/` - Добавить элемент в корзину
- `POST /api/cart/{id}/update_item/` - Обновить количество элемента
- `DELETE /api/cart/{id}/remove_item/?cart_item_id=...` - Удалить элемент

### Избранное
- `GET /api/favorites/` - Получить избранное
- `POST /api/favorites/` - Добавить в избранное
- `DELETE /api/favorites/{id}/` - Удалить из избранного

### Доставка
- `GET /api/delivery/` - Получить настройки доставки
- `POST /api/delivery/calculate/` - Рассчитать стоимость доставки

### Заказы
- `POST /api/orders/` - Создать заказ (обновлен для работы с новыми полями)

## Особенности

1. **Шифрование данных**: Email и телефон автоматически шифруются при сохранении в БД
2. **Работа без регистрации**: Пользователи могут делать заказы без регистрации, но email и телефон обязательны
3. **Корзина по сессии**: Для неавторизованных пользователей корзина сохраняется по session_key
4. **Расчет доставки**: Автоматический расчет стоимости доставки на основе почтового индекса и расстояния

## Тестирование

1. Запустите сервер разработки:
```bash
cd backend
python manage.py runserver
```

2. Откройте страницу заказов:
```
http://localhost:3000/ru/order
```

3. Проверьте работу:
   - Добавление блюд в корзину
   - Расчет доставки по почтовому индексу
   - Создание заказа

## Важные замечания

- **Не коммитьте ENCRYPTION_KEY в git!** Используйте переменные окружения
- Для production обязательно настройте email для отправки подтверждений
- Координаты точки доставки должны быть точными для правильного расчета расстояния
- При изменении ENCRYPTION_KEY все зашифрованные данные станут нечитаемыми

