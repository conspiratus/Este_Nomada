#!/usr/bin/expect -f

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Next.js

set timeout 60
set password "Jovi4AndMay2020!"
set host "85.190.102.101"
set user "administrator"

puts "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°..."
spawn ssh -o StrictHostKeyChecking=no $user@$host "sudo systemctl status estenomada-frontend --no-pager | head -15"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof { 
        puts ""
    }
}

sleep 2

puts "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð»Ð¾Ð³Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ°..."
spawn ssh -o StrictHostKeyChecking=no $user@$host "sudo journalctl -u estenomada-frontend -n 30 --no-pager | tail -20"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof { 
        puts ""
    }
}

sleep 2

puts "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÑŽ ÑÐµÑ€Ð²Ð¸Ñ..."
spawn ssh -o StrictHostKeyChecking=no $user@$host "sudo systemctl restart estenomada-frontend && sleep 5 && sudo systemctl is-active estenomada-frontend && echo 'âœ… Ð¡ÐµÑ€Ð²Ð¸Ñ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½'"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof { 
        puts ""
    }
}

sleep 3

puts "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ..."
spawn ssh -o StrictHostKeyChecking=no $user@$host "curl -sI https://estenomada.es/en 2>&1 | head -5"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    eof { 
        puts ""
    }
}

puts "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"

