#!/usr/bin/expect -f

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx

set timeout 120
set server "administrator@85.190.102.101"
set password "Jovi4AndMay2020!"

puts "=========================================="
puts "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
puts "=========================================="

spawn scp /Users/conspiratus/Projects/Este_Nomada/nginx/estenomada.production.conf $server:/tmp/estenomada_new.conf
expect {
    "password:" {
        send "$password\r"
    }
}

expect eof

spawn ssh $server
expect {
    "password:" {
        send "$password\r"
    }
}

expect "administrator@*"

# –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø
puts "\nüíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞..."
send "sudo cp /etc/nginx/sites-available/estenomada /etc/nginx/sites-available/estenomada.backup_chef\r"
expect "administrator@*"

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
puts "\nüìù –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
send "sudo cp /tmp/estenomada_new.conf /etc/nginx/sites-available/estenomada\r"
expect "administrator@*"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
puts "\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ nginx..."
send "sudo nginx -t\r"
expect "administrator@*"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
puts "\nüîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx..."
send "sudo systemctl reload nginx\r"
expect {
    "password" {
        send "$password\r"
        exp_continue
    }
    "administrator@*" {
        puts "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    }
}

send "exit\r"
expect eof

puts "\n=========================================="
puts "‚úÖ –ì–æ—Ç–æ–≤–æ!"
puts "–ü—Ä–æ–≤–µ—Ä—å: https://estenomada.es/en/chef"
puts "=========================================="
