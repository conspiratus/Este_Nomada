name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub UI

# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –¥–µ–ø–ª–æ–∏ - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –¥–µ–ø–ª–æ–π –∑–∞ —Ä–∞–∑
# –ï—Å–ª–∏ –¥–µ–ø–ª–æ–π —É–∂–µ –∏–¥–µ—Ç, –Ω–æ–≤—ã–µ –±—É–¥—É—Ç –∂–¥–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏
concurrency:
  group: deploy-production
  cancel-in-progress: false  # –ù–µ –æ—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –¥–µ–ø–ª–æ–π, —Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ CI –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ –∏ —ç—Ç–æ push –≤ main/master
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check Django
        working-directory: ./backend
        run: python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: este_nomada.settings
          USE_SQLITE: 'True'  # –î–ª—è CI –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLite
      
      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.mjs \
            server.js \
            tsconfig.json \
            middleware.ts \
            i18n.ts \
            lib \
            app \
            components \
            types \
            messages \
            backend \
            nginx \
            systemd \
            scripts \
            prerender-manifest.json
      
      - name: Check secrets
        run: |
          if [ -z "${{ secrets.PROD_SERVER_HOST }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_USER }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.PROD_SERVER_PASSWORD }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: PROD_SERVER_PASSWORD –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
      
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"
          timeout: 300s
          debug: true
          use_insecure_cipher: false
          overwrite: true
          rm: false
      
      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          timeout: 300s
          debug: true
          use_insecure_cipher: false
          script: |
            set -e  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
            
            DEPLOY_DIR="/var/www/estenomada"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            FRONTEND_DIR="$DEPLOY_DIR"
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
            safe_run() {
              echo "‚ñ∂Ô∏è  –í—ã–ø–æ–ª–Ω—è—é: $@"
              if "$@"; then
                echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $@"
                return 0
              else
                echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º): $@"
                return 0  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
              fi
            }
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            if [ -d "$DEPLOY_DIR" ]; then
              echo "üì¶ –°–æ–∑–¥–∞—é –±—ç–∫–∞–ø..."
              sudo tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
            fi
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            sudo mkdir -p $DEPLOY_DIR
            cd /tmp
            if [ ! -f "deploy.tar.gz" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: deploy.tar.gz –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi
            echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: $(du -h deploy.tar.gz)"
            sudo tar -xzf deploy.tar.gz -C $DEPLOY_DIR
            if [ $? -ne 0 ]; then
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ!"
              exit 1
            fi
            sudo rm deploy.tar.gz
            echo "‚úÖ –ö–æ–¥ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞..."
            sudo chown -R www-data:www-data $DEPLOY_DIR
            sudo find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            sudo chmod +x $DEPLOY_DIR/scripts/*.sh 2>/dev/null || true
            
            # Backend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $BACKEND_DIR
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python (–∏—Å–ø–æ–ª—å–∑—É–µ–º python3.12 –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            PYTHON_CMD=$(which python3.12 || which python3 || which python)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Python: $PYTHON_CMD"
            $PYTHON_CMD --version
            
            # –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º venv –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
            echo "–°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo rm -rf venv
            sudo -u www-data $PYTHON_CMD -m venv venv
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ venv
            echo "–ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –≤ venv..."
            sudo chmod +x venv/bin/* 2>/dev/null || true
            sudo chown -R www-data:www-data venv
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ venv —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            if [ ! -f "venv/bin/python" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: venv –Ω–µ —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
              ls -la venv/bin/ || true
              echo "–ü—Ä–æ–±—É—é —Å–æ–∑–¥–∞—Ç—å venv —Å–Ω–æ–≤–∞..."
              sudo rm -rf venv
              sudo -u www-data $PYTHON_CMD -m venv venv
              sudo chmod +x venv/bin/* 2>/dev/null || true
              sudo chown -R www-data:www-data venv
              if [ ! -f "venv/bin/python" ]; then
                echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å venv"
                exit 1
              fi
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É—è python -m pip (–Ω–∞–¥–µ–∂–Ω–µ–µ)
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é pip –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            if ! sudo -u www-data venv/bin/python -m pip install --upgrade pip; then
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ pip"
              exit 1
            fi
            if ! sudo -u www-data venv/bin/python -m pip install --no-cache-dir -r requirements.txt; then
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
              exit 1
            fi
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # Backend: —Å–æ–∑–¥–∞–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è  –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ ! -f ".env" ] && [ ! -f ".env.production" ]; then
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
            fi
            
            # makemigrations - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
            set +e  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –¥–ª—è makemigrations
            MAKEMIGRATIONS_OUTPUT=$(sudo -u www-data venv/bin/python manage.py makemigrations 2>&1)
            MAKEMIGRATIONS_EXIT=$?
            set -e  # –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            
            if [ $MAKEMIGRATIONS_EXIT -eq 0 ]; then
              if echo "$MAKEMIGRATIONS_OUTPUT" | grep -q "No changes detected"; then
                echo "‚ÑπÔ∏è  –ù–µ—Ç –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è"
              else
                echo "‚úÖ –ù–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã:"
                echo "$MAKEMIGRATIONS_OUTPUT" | head -20
              fi
            else
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º):"
              echo "$MAKEMIGRATIONS_OUTPUT" | head -10
            fi
            
            echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
            if [ ! -f ".env" ] && [ ! -f ".env.production" ]; then
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
              echo "–ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ systemd..."
              sudo systemctl show estenomada-backend | grep -i environment || true
            fi
            
            set +e  # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—à–∏–±–æ–∫
            MIGRATE_OUTPUT=$(sudo -u www-data venv/bin/python manage.py migrate --noinput 2>&1)
            MIGRATE_EXIT=$?
            set -e  # –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            
            if [ $MIGRATE_EXIT -eq 0 ]; then
              echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
            else
              echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π!"
              echo "–í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã migrate:"
              echo "$MIGRATE_OUTPUT"
              echo ""
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –±—ã—Ç—å —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î
              if echo "$MIGRATE_OUTPUT" | grep -qi "connection\|database\|mysql\|access denied"; then
                echo "‚ö†Ô∏è  –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î"
                echo "–ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î..."
                sudo -u www-data venv/bin/python -c "import os; import sys; sys.path.insert(0, '.'); os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'este_nomada.settings'); import django; django.setup(); from django.conf import settings; print('DB_NAME:', settings.DATABASES['default'].get('NAME', 'NOT SET')); print('DB_USER:', settings.DATABASES['default'].get('USER', 'NOT SET')); print('DB_HOST:', settings.DATABASES['default'].get('HOST', 'NOT SET'))" 2>&1 || true
              fi
              
              echo ""
              echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π..."
              sudo -u www-data venv/bin/python manage.py showmigrations 2>&1 | head -30 || true
              echo ""
              echo "‚ö†Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞—é –¥–µ–ø–ª–æ–π –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É –º–∏–≥—Ä–∞—Ü–∏–π"
              echo "–ú–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é –ø–æ–∑–∂–µ"
            fi
            
            # Backend: —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É Django..."
            sudo -u www-data venv/bin/python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ collectstatic, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            
            # Frontend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $FRONTEND_DIR
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .next –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            if [ ! -d ".next" ]; then
              echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: .next –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              echo "–ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
              ls -la | grep -E "\.next|out|build" || true
              echo "–ü–æ–ø—Ä–æ–±—É—é —Å–æ–±—Ä–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
              if [ -f "package.json" ]; then
                sudo -u www-data npm run build || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
              fi
              if [ ! -d ".next" ]; then
                echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Frontend –Ω–µ —Å–æ–±—Ä–∞–Ω –∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
                exit 1
              fi
            fi
            
            # –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º)
            echo "–û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            sudo rm -rf node_modules package-lock.json 2>/dev/null || true
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–Ω—É–∂–Ω—ã –≤—Å–µ, –Ω–µ —Ç–æ–ª—å–∫–æ production, –¥–ª—è server.js)
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            if ! sudo -u www-data npm install; then
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
              echo "–ü—Ä–æ–±—É—é —Å –ø—Ä–∞–≤–∞–º–∏ root..."
              sudo npm install || exit 1
              sudo chown -R www-data:www-data node_modules package-lock.json 2>/dev/null || true
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ next —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            if [ ! -d "node_modules/next" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –º–æ–¥—É–ª—å 'next' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
              ls -la node_modules/ | head -10
              exit 1
            fi
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # –û—á–∏—â–∞–µ–º –∫—ç—à Python
            echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à Python..."
            sudo find $BACKEND_DIR -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            sudo find $BACKEND_DIR -name '*.pyc' -delete 2>/dev/null || true
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            set +e  # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞ –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
            if systemctl list-unit-files | grep -q estenomada-backend; then
              sudo systemctl restart estenomada-backend
              BACKEND_RESTART=$?
              sleep 2
              if [ $BACKEND_RESTART -eq 0 ]; then
                echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              else
                echo "‚ö†Ô∏è  Backend –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (–∫–æ–¥: $BACKEND_RESTART)"
                echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å backend..."
                sudo systemctl status estenomada-backend --no-pager -l | head -20 || true
              fi
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å estenomada-backend –Ω–µ –Ω–∞–π–¥–µ–Ω"
              BACKEND_RESTART=1
            fi
            
            if systemctl list-unit-files | grep -q estenomada-frontend; then
              sudo systemctl restart estenomada-frontend
              FRONTEND_RESTART=$?
              sleep 2
              if [ $FRONTEND_RESTART -eq 0 ]; then
                echo "‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              else
                echo "‚ö†Ô∏è  Frontend –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (–∫–æ–¥: $FRONTEND_RESTART)"
                echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å frontend..."
                sudo systemctl status estenomada-frontend --no-pager -l | head -20 || true
              fi
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å estenomada-frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
              FRONTEND_RESTART=1
            fi
            set -e
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
            set +e
            sudo nginx -t
            NGINX_TEST=$?
            if [ $NGINX_TEST -eq 0 ]; then
              sudo systemctl reload nginx
              echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
            else
              echo "‚ö†Ô∏è  Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏"
            fi
            set -e
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
            echo ""
            echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
            echo "--- Backend ---"
            if systemctl list-unit-files | grep -q estenomada-backend; then
              BACKEND_STATUS=$(sudo systemctl is-active estenomada-backend 2>&1 || echo "inactive")
              if [ "$BACKEND_STATUS" = "active" ]; then
                echo "‚úÖ Backend –∞–∫—Ç–∏–≤–µ–Ω"
              else
                echo "‚ö†Ô∏è  Backend –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (—Å—Ç–∞—Ç—É—Å: $BACKEND_STATUS)"
                echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend:"
                sudo journalctl -u estenomada-backend -n 10 --no-pager || true
              fi
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å estenomada-backend –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            echo "--- Frontend ---"
            if systemctl list-unit-files | grep -q estenomada-frontend; then
              FRONTEND_STATUS=$(sudo systemctl is-active estenomada-frontend 2>&1 || echo "inactive")
              if [ "$FRONTEND_STATUS" = "active" ]; then
                echo "‚úÖ Frontend –∞–∫—Ç–∏–≤–µ–Ω"
              else
                echo "‚ö†Ô∏è  Frontend –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω (—Å—Ç–∞—Ç—É—Å: $FRONTEND_STATUS)"
                echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ frontend:"
                sudo journalctl -u estenomada-frontend -n 10 --no-pager || true
              fi
            else
              echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å estenomada-frontend –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            echo ""
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:"
            echo "   Backend: ${BACKEND_STATUS:-unknown}"
            echo "   Frontend: ${FRONTEND_STATUS:-unknown}"
            
            # –ï—Å–ª–∏ –æ–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã, —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
            if [ "$BACKEND_STATUS" != "active" ] && [ "$FRONTEND_STATUS" != "active" ]; then
              echo ""
              echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –æ–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã!"
              exit 1
            fi
      
      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz
