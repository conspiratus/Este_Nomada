name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub UI

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      
      - name: Check Django
        working-directory: ./backend
        run: python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: este_nomada.settings
          USE_SQLITE: 'True'  # –î–ª—è CI –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLite
      
      - name: Create deployment archive
        run: |
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.mjs \
            server.js \
            tsconfig.json \
            middleware.ts \
            i18n.ts \
            lib \
            app \
            components \
            types \
            messages \
            backend \
            nginx \
            systemd \
            scripts \
            prerender-manifest.json
      
      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"
      
      - name: Extract and deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: 22
          script: |
            set -e  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
            
            DEPLOY_DIR="/var/www/estenomada"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            FRONTEND_DIR="$DEPLOY_DIR"
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
            safe_run() {
              echo "‚ñ∂Ô∏è  –í—ã–ø–æ–ª–Ω—è—é: $@"
              if "$@"; then
                echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $@"
                return 0
              else
                echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º): $@"
                return 0  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
              fi
            }
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            if [ -d "$DEPLOY_DIR" ]; then
              echo "üì¶ –°–æ–∑–¥–∞—é –±—ç–∫–∞–ø..."
              sudo tar -czf /tmp/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C $DEPLOY_DIR . 2>/dev/null || true
            fi
            
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
            echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
            sudo mkdir -p $DEPLOY_DIR
            cd /tmp
            sudo tar -xzf deploy.tar.gz -C $DEPLOY_DIR
            sudo rm deploy.tar.gz
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞..."
            sudo chown -R www-data:www-data $DEPLOY_DIR
            sudo find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            sudo chmod +x $DEPLOY_DIR/scripts/*.sh 2>/dev/null || true
            
            # Backend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $BACKEND_DIR
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python (–∏—Å–ø–æ–ª—å–∑—É–µ–º python3.12 –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            PYTHON_CMD=$(which python3.12 || which python3 || which python)
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Python: $PYTHON_CMD"
            $PYTHON_CMD --version
            
            # –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º venv –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
            echo "–°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo rm -rf venv
            sudo -u www-data $PYTHON_CMD -m venv venv
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ venv
            echo "–ò—Å–ø—Ä–∞–≤–ª—è—é –ø—Ä–∞–≤–∞ –≤ venv..."
            sudo chmod +x venv/bin/* 2>/dev/null || true
            sudo chown -R www-data:www-data venv
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ venv —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            if [ ! -f "venv/bin/python" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: venv –Ω–µ —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
              ls -la venv/bin/ || true
              exit 1
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É—è python -m pip (–Ω–∞–¥–µ–∂–Ω–µ–µ)
            echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é pip –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            sudo -u www-data venv/bin/python -m pip install --upgrade pip
            sudo -u www-data venv/bin/python -m pip install --no-cache-dir -r requirements.txt
            
            # Backend: –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
            sudo -u www-data venv/bin/python manage.py migrate --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            
            # Backend: —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            echo "üì¶ –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É Django..."
            sudo -u www-data venv/bin/python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ collectstatic, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            
            # Frontend: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            cd $FRONTEND_DIR
            if [ -f "package-lock.json" ]; then
              sudo -u www-data npm ci --production || sudo -u www-data npm install --production || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ npm, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            else
              sudo -u www-data npm install --production || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ npm, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            fi
            
            # –û—á–∏—â–∞–µ–º –∫—ç—à Python
            echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à Python..."
            sudo find $BACKEND_DIR -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            sudo find $BACKEND_DIR -name '*.pyc' -delete 2>/dev/null || true
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
            set +e  # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞ –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
            sudo systemctl restart estenomada-backend
            BACKEND_RESTART=$?
            sudo systemctl restart estenomada-frontend
            FRONTEND_RESTART=$?
            set -e
            
            if [ $BACKEND_RESTART -eq 0 ]; then
              echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ö†Ô∏è  Backend –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (–∫–æ–¥: $BACKEND_RESTART)"
            fi
            
            if [ $FRONTEND_RESTART -eq 0 ]; then
              echo "‚úÖ Frontend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ö†Ô∏è  Frontend –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (–∫–æ–¥: $FRONTEND_RESTART)"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx..."
            set +e
            sudo nginx -t
            NGINX_TEST=$?
            if [ $NGINX_TEST -eq 0 ]; then
              sudo systemctl reload nginx
              echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
            else
              echo "‚ö†Ô∏è  Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏"
            fi
            set -e
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
            echo "--- Backend ---"
            sudo systemctl is-active estenomada-backend && echo "‚úÖ Backend –∞–∫—Ç–∏–≤–µ–Ω" || echo "‚ö†Ô∏è  Backend –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
            echo "--- Frontend ---"
            sudo systemctl is-active estenomada-frontend && echo "‚úÖ Frontend –∞–∫—Ç–∏–≤–µ–Ω" || echo "‚ö†Ô∏è  Frontend –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
            
            echo ""
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:"
            echo "   Backend: $(sudo systemctl is-active estenomada-backend)"
            echo "   Frontend: $(sudo systemctl is-active estenomada-frontend)"
      
      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz
